<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Поиск рецептов</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <script>
        // Инициализация Telegram WebApp
        const tg = window.Telegram.WebApp;
        tg.expand(); // Раскрываем на всю высоту
        tg.ready(); // Сообщаем что приложение готово
    </script>

    <div class="container">
        <h1>Поиск рецептов по ингредиентам</h1>
        
        <div class="diet-filters">
            <select id="diet-select">
                <option value="">Все рецепты</option>
                <option value="vegetarian">Вегетарианские</option>
                <option value="vegan">Веганские</option>
                <option value="gluten-free">Без глютена</option>
                <option value="ketogenic">Кето</option>
            </select>
        </div>

        <div class="ingredients-input">
            <input type="text" id="ingredient" placeholder="Введите ингредиент" onkeypress="handleKeyPress(event)">
            <button onclick="addIngredient()">Добавить</button>
        </div>

        <div id="ingredients-list"></div>
        <button onclick="searchRecipes()">Найти рецепты</button>
        <div id="loading" class="loading" style="display: none;">Загрузка...</div>
        <div id="error" class="error" style="display: none;"></div>
        <div id="recipes-result"></div>
    </div>

    <script>
        let ingredients = [];

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                addIngredient();
            }
        }

        function addIngredient() {
            const input = document.getElementById('ingredient');
            if (input.value.trim()) {
                ingredients.push(input.value.trim());
                updateIngredientsList();
                input.value = '';
            }
        }

        function updateIngredientsList() {
            const list = document.getElementById('ingredients-list');
            list.innerHTML = ingredients.map(ing => 
                `<div>${ing} <button onclick="removeIngredient('${ing}')">✕</button></div>`
            ).join('');
        }

        function removeIngredient(ing) {
            ingredients = ingredients.filter(i => i !== ing);
            updateIngredientsList();
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            if (message) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
            } else {
                errorDiv.style.display = 'none';
            }
        }

        async function searchRecipes() {
            if (ingredients.length === 0) {
                showError('Добавьте хотя бы один ингредиент');
                return;
            }

            showError('');
            showLoading(true);

            try {
                const dietSelect = document.getElementById('diet-select');
                const response = await fetch('/api/search-recipes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        ingredients,
                        diet: dietSelect.value 
                    })
                });

                if (!response.ok) throw new Error('Ошибка при поиске рецептов');
                
                const recipes = await response.json();
                await displayRecipes(recipes);
            } catch (error) {
                showError(error.message);
            } finally {
                showLoading(false);
            }
        }

        async function getRecipeDetails(id) {
            const response = await fetch(`/api/recipe/${id}`);
            if (!response.ok) throw new Error('Ошибка при получении деталей рецепта');
            return await response.json();
        }

        async function displayRecipes(recipes) {
            const container = document.getElementById('recipes-result');
            container.innerHTML = '';

            if (recipes.length === 0) {
                container.innerHTML = '<p>Рецепты не найдены</p>';
                return;
            }

            for (const recipe of recipes) {
                try {
                    const details = await getRecipeDetails(recipe.id);
                    const recipeCard = document.createElement('div');
                    recipeCard.className = 'recipe-card';
                    recipeCard.innerHTML = `
                        <h3>${recipe.title}</h3>
                        <img src="${recipe.image}" class="recipe-image" alt="${recipe.title}">
                        <p>Использовано ингредиентов: ${recipe.usedIngredientCount}</p>
                        <p>Время приготовления: ${details.readyInMinutes} минут</p>
                        <p>Порций: ${details.servings}</p>
                        ${details.vegetarian ? '<span>Вегетарианское</span> ' : ''}
                        ${details.vegan ? '<span>Веганское</span> ' : ''}
                        <h4>Инструкция:</h4>
                        <p>${details.instructions || 'Инструкция недоступна'}</p>
                    `;
                    container.appendChild(recipeCard);
                } catch (error) {
                    console.error('Error fetching recipe details:', error);
                }
            }
        }

        // Добавляем стили Telegram
        document.body.style.backgroundColor = tg.backgroundColor;
        document.body.style.color = tg.textColor;
    </script>
</body>
</html>
